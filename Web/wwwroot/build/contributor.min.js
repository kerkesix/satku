var Barcode=function(n,t){var i=12;if(!n||typeof n!="function")throw new Error("Must specify a callback function that is called when barcode is complete.");if(typeof t!="undefined"){if(t&&isNaN(t))throw new Error("Given expected barcode length must be a number.");i=t}this._callback=n;this._buffer="";this._validate=new RegExp("\\w{"+i+"}");this._timeout=null;document.addEventListener("keyup",this.readKey.bind(this),!1)},Beep,__extends,Ksx;Barcode.prototype.readKey=function(n){var t=this;n.keyCode!==16&&(n.keyCode===13&&this._buffer&&this._buffer.match(this._validate)&&this._callback.call(this,this._buffer),n.keyCode>=48&&n.keyCode<=90?(this._buffer+=String.fromCharCode(n.keyCode),this._timeout&&window.clearTimeout(this._timeout),this._timeout=setTimeout(function(){t._buffer=""},50)):this._buffer="")};Barcode.prototype.simulateReading=function(n){for(var t=0;t<n.length;t++)this.readKey(Barcode.simulatedKeyEvent(n.charCodeAt(t)));this.readKey(Barcode.simulatedKeyEvent(13))};Barcode.simulatedKeyEvent=function(n){return{keyCode:n}};Beep=function(n,t){this.length=isNaN(t)?250:t;this.frequency=isNaN(n)?1700:n;this.audioCtx=new(window.AudioContext||window.webkitAudioContext)};Beep.prototype.play=function(n){var r=this,u=this.length,t,i;this.audioCtx&&(t=this.audioCtx.createOscillator(),i=this.audioCtx.createGain(),t.connect(i),i.connect(this.audioCtx.destination),t.type="square",t.frequency.value=this.frequency,t.start(),setTimeout(function(){t.stop();n>1&&(n--,setTimeout(function(){r.play(n)},150))},this.length))};__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(){var i=t.call(this,"scaninstructions")||this,r=i,u={urlMap:["/scaninstructions"],order:94,text:"Luentaohjeet",icon:"fa-info-sign",active:!1,root:i.domroot,showOnNavigation:!1,onViewOpen:r.onload.bind(i)};return n.Routes.register(i.domroot,u),i}return __extends(i,t),i}(n.ViewModelBase);n.ScanInstructionsViewModel=t;t.instance=new t}(Ksx||(Ksx={})),function(n){var t=function(){function t(n){this.barcode=n}return t.prototype.validate=function(){return this.isTestBarcode()?(Messaging.Queues.success.publish("Testiluku onnistui! Tämä todistaa, että lukija ja selain toimivat yhdessä, yhteyttä palvelimeen ei testattu."),n.Track.pageEvent("scanvalidate","test",this.barcode),!1):this.personIsLinkedToCurrentHappening()?this.personHasQuit()?(Messaging.Queues.error.publish("Henkilö on keskeyttänyt, lukemia ei voi enää lisätä."),n.Track.pageEvent("scanvalidate","failquit",this.barcode),!1):this.personHasCompleted()?(Messaging.Queues.error.publish("Henkilö on jo maalissa, lukemia ei voi enää lisätä."),n.Track.pageEvent("scanvalidate","failcompleted",this.barcode),!1):!0:(Messaging.Queues.error.publish("Virheellinen luenta! henkilöä ei löydy osallistujien listalta: "+this.barcode),n.Track.pageEvent("scanvalidate","failnotlinked",this.barcode),!1)},t.prototype.isTestBarcode=function(){return this.barcode==="A1234567"},t.prototype.personIsLinkedToCurrentHappening=function(){return!!n.ReferenceData.attendeesMap[this.barcode]},t.prototype.personHasQuit=function(){return!!n.ReferenceData.quitAttendees[this.barcode]},t.prototype.personHasCompleted=function(){return!!n.ReferenceData.completedAttendees[this.barcode]},t}();n.ScanValidator=t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var i=function(){function n(n,t,i){this.id=n;this.person=t;this.timestamp=i;this.status=ko.observable("new");this.text=ko.observable();this.error=ko.observable()}return n}(),t;n.ScanLogRow=i;t=function(t){function r(){var i=t.call(this,"scan")||this,u,f;return i.rows=ko.observableArray([]),i.windowActive=ko.observable(!0),i.beep=new Beep(1700,200),u=i,f={urlMap:["/scanlog"],order:94,text:"Luentaloki",icon:"fa-list-ol",active:!1,root:i.domroot,showOnNavigation:!1,onViewOpen:u.onload.bind(i)},n.Routes.register(i.domroot,f),i.barcodeReader=new Barcode(function(n){return i.barcodeComplete(n)},8),i.nfcCodeReader=new Barcode(function(n){return i.barcodeComplete(i.nfcTagToPersonId(n))},10),console.log("Bar code reader initialized, waiting..."),n.Bus.initialize.then(function(){Messaging.Queues.checkpointForScanResponse.subscribe(n.Bus.bus.send.bind(n.Bus.bus))}),Messaging.Queues.commandAck.subscribe(function(n){i.rows().forEach(function(t){t.id===n.id&&t.status("ack")})}),Messaging.Queues.eventsFromServer.subscribe(function(t){if(typeof r.successEvents[t.name]!="undefined"){i.setRowStatus(t.data,r.successEvents[t.name]);n.Track.pageEvent("scanresponse","ok",t.name);return}if(typeof r.errorEvents[t.name]!="undefined"){i.setRowStatus(t.data,null,r.errorEvents[t.name]);n.Track.pageEvent("scanresponse","fail",t.name);return}}),window.onfocus=function(){return i.windowActive(!0)},window.onblur=function(){return i.windowActive(!1)},i}return __extends(r,t),r.prototype.nfcTagToPersonId=function(t){return n.Track.pageEvent("nfc","complete",t),n.ReferenceData.nfcMap.hasOwnProperty(t)?n.ReferenceData.nfcMap[t]:t},r.prototype.barcodeComplete=function(t){var u,r,f;(console.log("barcode",t),n.Track.pageEvent("barcode","complete",t),u=new n.ScanValidator(t),u.validate())&&(r=n.Bus.createCommand("Scan",{HappeningId:n.Routes.currentHappening,PersonId:t}),f=new i(r.id,t,r.timestamp),this.rows.push(f),Messaging.Queues.checkpointForScanRequest.publish(r),this.beep.play(1),n.Track.pageEvent("scan","send",t))},r.prototype.findRow=function(n){return this.rows().reduce(function(t,i){return i.person===n.personId&&i.status()==="ack"?i:t},null)},r.prototype.setRowStatus=function(n,t,i){var r=this.findRow(n);r&&(t&&(r.status("ok"),r.text(t)),i&&(r.status("error"),r.error(i)))},r.errorEvents={AttendeeDoubleScan:"Tuplaluenta",AttendeeScanOutPreceedsScanIn:"Ulosluenta ennen sisäänluentaa"},r.successEvents={AttendeeScanIn:"sisään",AttendeeScanOut:"ulos",AttendeePassthroughScan:"läpi"},r}(n.ViewModelBase);n.ScanViewModel=t;t.instance=new t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(){var i=t.call(this,"startscan")||this,r,u;return i.allAttendees=ko.observableArray([]),i.time=ko.observable(),r=i,u={urlMap:["/readings/start"],order:94,text:"Aloituslukema",icon:"fa-list-ol",active:!1,root:i.domroot,showOnNavigation:!1,onViewOpen:r.onload.bind(i)},n.Routes.register(i.domroot,u),Messaging.Queues.referenceData.subscribe(function(n){n.name==="attendees"&&(i.allAttendees=ko.observableArray(n.data));n.name==="checkpoints"&&(i.checkpoints=n.data)}),i}return __extends(i,t),i.prototype.add=function(){if(this.allAttendees().length&&this.checkpoints.length){var t=this.checkpoints[0].id,i=n.Routes.currentHappening,r=n.Time.ToServerTimeFromInputDate(this.time());this.allAttendees().forEach(function(u){var f=n.Bus.createCommand("StartScan",{PersonId:u.id,CheckpointId:t,HappeningId:i,ScanTimestamp:r});n.Bus.bus.send(f)});Messaging.Queues.info.publish("Aloituslukemia tallennetaan...")}this.sammyContext.redirect("/")},i}(n.ViewModelBase);n.StartScanViewModel=t;t.instance=new t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(){function t(n){this.Key=ko.observable(n?n.key:"");this.CheckpointCount=ko.observable(n?n.checkpointCount:0);this.Coordinates=ko.observable(n?n.path:"");this.CoordinatesOpen=ko.observable(!1)}return t.prototype.toggleCoordinatesOpen=function(){this.CoordinatesOpen(!this.CoordinatesOpen())},t.prototype.parseKmlFormat=function(){var t=this.Coordinates(),n;n=this.extractCoordinatesFromKml(t).split(",0.0").map(function(n){return n.replace(/\s/g,"").split(",")}).filter(function(n){return n.length>1});this.Coordinates(JSON.stringify(n).replace(/\"/g,""))},t.prototype.extractCoordinatesFromKml=function(n){var t=n.indexOf("<LineString>"),i=[];if(t<=0)return n;while(t>0){var r=n.indexOf("<coordinates>",t),u=n.indexOf("<\/coordinates>",t),f=n.indexOf("<\/LineString>",t);i.push(n.substring(r+13,u));t=n.indexOf("<LineString>",f)}return i.join(" ")},t.prototype.addCoordinates=function(){var t=n.Bus.createCommand("AddCoordinatePath",{key:this.Key(),path:this.Coordinates().trim()});n.Bus.bus.send(t);Messaging.Queues.info.publish("Lisätään koordinaatteja... ");this.CoordinatesOpen(!1)},t}(),i;n.Happening=t;i=function(i){function r(){var r=i.call(this,"edithappenings")||this,u,f;return r.newHappening=new t,r.defaultHappening=ko.observable(""),u=r,f={urlMap:["/edit/happenings"],order:90,text:"Muokkaa tapahtumia",icon:"fa-trophy",active:!1,tag:"admin",root:r.domroot,showOnNavigation:!0,onViewOpen:u.onload.bind(r)},n.Routes.register(r.domroot,f),r}return __extends(r,i),r.prototype.onload=function(){var i=this,r=this;this.loaded()||n.DataClient.happenings().done(function(n){var u=null,f=(n||[]).map(function(n){return n.isDefault&&(u=n.key),new t(n)});i.happenings=ko.observableArray(f);i.applyBindings();i.defaultHappening(u);i.defaultHappening.subscribe(r.saveDefault)})},r.prototype.saveNewHappening=function(){var i=n.Bus.createCommand("CreateHappening",{key:this.newHappening.Key()});n.Bus.bus.send(i);this.happenings.push(new t({key:this.newHappening.Key(),isDefault:!1,checkpointCount:0,path:""}));this.newHappening.Key("");Messaging.Queues.info.publish("Tallennetaan uutta tapahtumaa '"+i.key+"'...")},r.prototype.saveDefault=function(t){var i=n.Bus.createCommand("ChangeDefaultHappening",{key:t});n.Bus.bus.send(i);Messaging.Queues.info.publish("Vaihdetaan oletustapahtumaksi '"+t+"'...")},r.prototype.deleteHappening=function(t){var i=n.Bus.createCommand("DeleteHappening",{key:t.Key()});n.Bus.bus.send(i);this.happenings.remove(t);Messaging.Queues.info.publish("Poistetaan tapahtumaa '"+t.Key()+"'...")},r}(n.ViewModelBase);n.EditHappeningsViewModel=i;i.instance=new i}(Ksx||(Ksx={})),function(n){var t=function(){function n(n){this.Id=n.personId;this.Email=n.email;this.Phone=n.phone;this.Name=n.name}return n}();n.LinkPerson=t}(Ksx||(Ksx={})),function(n){var t=function(){function t(n,t){var i=this;this.selectedPerson=ko.observable();this.id=ko.observable(n.id);this.personId=n.newPersonId;this.time=ko.observable(n.timestamp);this.confirmedAt=ko.observable(n.confirmedAt);this.lastname=ko.observable(n.lastname);this.firstname=ko.observable(n.firstname);this.displayName=ko.observable(n.displayName);this.email=ko.observable(n.email);this.phone=ko.observable(n.phone);this.isMember=ko.observable(n.isMember);this.beenThere=ko.observable(n.beenThere);this.info=ko.observable(n.info);this.linkedToPerson=ko.observable(n.linkedToPerson);this.showName=ko.pureComputed(function(){var n=i.lastname()+" "+i.firstname();return n===i.displayName()?n:n+" ("+i.displayName()+")"});this.availablePeople=ko.observableArray(t);Messaging.Queues.eventsFromServer.subscribe(function(n){n.name==="PersonLinkedToHappening"&&i.availablePeople.remove(function(t){return t.Id===n.data.personId})})}return t.prototype.link=function(){var i=this.selectedPerson(),r=i?this.linkToExistingPerson(i.Id):this.linkToNewPerson(),t=n.Bus.createCommand("LinkPersonToHappening",{PersonId:r,HappeningId:n.Routes.currentHappening,RegistrationId:this.id()});return this.linkedToPerson(r),t.timestamp=n.Time.AddMs(n.Time.ServerTime,1e3),setTimeout(function(){return n.Bus.bus.send(t)},500),Messaging.Queues.info.publish((i?"Päivitetään":"Luodaan")+" henkilöä "+t.PersonId+" ja sidotaan satkuun "+t.HappeningId+"."),!1},t.prototype.unlink=function(){var t=n.Bus.createCommand("UnlinkPersonFromHappening",{PersonId:this.linkedToPerson(),HappeningId:n.Routes.currentHappening,RegistrationId:this.id()});n.Bus.bus.send(t);this.linkedToPerson(null);Messaging.Queues.info.publish("Poistetaan linkitystä "+t.PersonId+" -> "+t.HappeningId+"...")},t.prototype.linkToNewPerson=function(){var t=ko.toJS(this),i=n.Bus.createCommand("CreatePerson",t);return n.Bus.bus.send(i),this.personId},t.prototype.linkToExistingPerson=function(t){var i=ko.toJS(this);return i.PersonId=t,n.Bus.bus.send(n.Bus.createCommand("UpdateContactInformation",i)),t},t}();n.RegistrationRow=t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(){var i=t.call(this,"registrations")||this,r=i,u={urlMap:["/edit/registrations"],order:90,text:"Ilmoittautumiset",icon:"fa-random",active:!1,tag:"admin",root:i.domroot,showOnNavigation:!0,onViewOpen:r.onload.bind(i)};return n.Routes.register(i.domroot,u),i}return __extends(i,t),i.prototype.remove=function(t){var i=n.Bus.createCommand("DeleteRegistration",{happeningId:n.Routes.currentHappening,registrationId:t.id()});n.Bus.bus.send(i);this.rows.remove(t);$(".modal").modal("hide")},i.prototype.onload=function(){var t=this;this.loaded()||$.when(n.DataClient.registrations(),n.DataClient.linkPeople()).done(function(i,r){var u=(r[0]||[]).map(function(t){return new n.LinkPerson(t)}),f=(i[0]||[]).map(function(t){return new n.RegistrationRow(t,u)});t.rows=ko.observableArray(f);t.applyBindings()})},i}(n.ViewModelBase);n.RegistrationsViewModel=t;t.instance=new t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var i=function(){function t(t){this.nfcId=ko.observable("");n.Mutator.DtoToKnockoutObservableModel(this,t);this.personId=ko.observable(t.id)}return t.prototype.isLinkedTo=function(n){return this.happeningsAttended().some(function(t){return t===n})},t}(),t;n.Person=i;t=function(t){function r(){var i=t.call(this,"people")||this,r,u;return i.onlyCurrent=ko.observable(!0),r=i,u={urlMap:["/edit/people"],order:90,text:"Henkilöt",icon:"fa-th-list",active:!1,tag:"admin",root:i.domroot,showOnNavigation:!0,onViewOpen:r.onload.bind(i)},n.Routes.register(i.domroot,u),i}return __extends(r,t),r.prototype.refreshData=function(){var r=this,t=$.Deferred();return n.DataClient.people().done(function(n){var u=(n||[]).map(function(n){return new i(n)});r.people=ko.observableArray(u);t.resolve()}),t.promise()},r.prototype.onload=function(){var n=this;this.loaded()||this.refreshData().then(function(){return n.applyBindings()},function(){return Messaging.Queues.error.publish("Henkilöiden lataus palvelimelta epäonnistui.")})},r.prototype.deletePerson=function(t){var i=n.Bus.createCommand("DeletePerson",{personId:t.personId()});n.Bus.bus.send(i);this.people.remove(t);Messaging.Queues.success.publish("Henkilö '"+t.lastname()+" "+t.firstname()+"' poistettu.");this.closeEditor()},r.prototype.initializeEditor=function(n){return this.editorPerson=n,n},r.prototype.updateInformation=function(){var r=this,t=ko.toJS(this.editorPerson),u=n.Bus.createCommand("UpdateContactInformation",t),i;n.Bus.bus.send(u);i=this.people().filter(function(n){return n.personId()===r.editorPerson.personId()})[0];i.nfcId(t.nfcId);i.lastname(t.lastname);i.firstname(t.firstname);i.displayName(t.displayName);i.email(t.email);i.twitter(t.twitter);i.phone(t.phone);Messaging.Queues.info.publish("Tallennetaan henkilön "+t.displayName+" tietoja...");this.closeEditor();n.Track.pageEvent("people","update",i.personId())},r.prototype.closeEditor=function(){$(".modal").modal("hide")},r}(n.ViewModelBase);n.PeopleViewModel=t;t.instance=new t}(Ksx||(Ksx={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t=function(t){function i(){var i=t.call(this,"system")||this,r=i,u={urlMap:["/edit/system"],order:99,text:"Järjestelmä",icon:"fa-cogs",active:!1,tag:"admin",root:i.domroot,showOnNavigation:!0,onViewOpen:r.onload.bind(i)};return n.Routes.register(i.domroot,u),i}return __extends(i,t),i.prototype.refresh=function(){n.DataClient.refresh().done(function(){n.Track.pageEvent("system","restart","");setTimeout(function(){window.location.href="/"},4e3);Messaging.Queues.success.publish("Järjestelmä käynnistetty uudelleen., sinut ohjataan etusivulle...")}).fail(Messaging.Queues.error.publish.bind(this,"Järjestelmän käynnistäminen epäonnistui"))},i}(n.ViewModelBase);n.SystemViewModel=t;t.instance=new t}(Ksx||(Ksx={}));
//# sourceMappingURL=contributor.min.js.map